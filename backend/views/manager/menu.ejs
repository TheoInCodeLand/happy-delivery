<%- include('../layouts/main', { title: 'Menu Management', currentPage: 'menus' }) %>

<div class="menus-page">
    <div class="row mb-4">
        <div class="col-md-4">
            <h2>Menu Management</h2>
            <p class="text-muted">Manage menus and items for your restaurants</p>
        </div>
        <div class="col-md-8">
            <div class="d-flex justify-content-end gap-2">
                <select class="form-select w-auto" id="restaurantSelect" onchange="loadMenus(this.value)">
                    <% restaurants.forEach(restaurant => { %>
                    <option value="<%= restaurant.id %>" <%= restaurant.id === (selectedRestaurant?.id || '') ? 'selected' : '' %>>
                        <%= restaurant.name %>
                    </option>
                    <% }) %>
                </select>
                <button class="btn btn-primary" onclick="addNewMenu()">
                    <i class="fas fa-plus"></i> Add Menu
                </button>
                <button class="btn btn-success" onclick="addNewItem()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        </div>
    </div>

    <!-- Menu Categories -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Menu Categories</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="menuList">
                        <!-- Menu categories will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Menu Items -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" id="currentMenuTitle">Select a Menu</h6>
                    <div class="search-box">
                        <input type="text" class="form-control form-control-sm" placeholder="Search items..." id="searchItems">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="itemsTable">
                            <thead>
                                <tr>
                                    <th width="60">
                                        <input type="checkbox" id="selectAllItems">
                                    </th>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Popular</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="itemsList">
                                <!-- Items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="bulk-actions mt-3" id="bulkActions" style="display: none;">
                        <button class="btn btn-sm btn-success" onclick="bulkUpdateStatus(true)">
                            <i class="fas fa-check"></i> Enable Selected
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="bulkUpdateStatus(false)">
                            <i class="fas fa-times"></i> Disable Selected
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="deleteSelectedItems()">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Menu Modal -->
<div class="modal fade" id="addMenuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Menu</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addMenuForm">
                    <div class="mb-3">
                        <label class="form-label">Menu Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" name="display_order" value="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="is_active">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMenu()">Save Menu</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemModalTitle">Add New Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Item Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-control" name="category" placeholder="e.g., Main Course">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price (₹) *</label>
                            <input type="number" step="0.01" class="form-control" name="price" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Discounted Price (₹)</label>
                            <input type="number" step="0.01" class="form-control" name="discounted_price">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Preparation Time (minutes)</label>
                            <input type="number" class="form-control" name="preparation_time_minutes" value="15">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Calories</label>
                            <input type="number" class="form-control" name="calories">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Veg/Non-Veg</label>
                            <select class="form-select" name="is_veg">
                                <option value="true">Vegetarian</option>
                                <option value="false">Non-Vegetarian</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Availability</label>
                            <select class="form-select" name="is_available">
                                <option value="true">Available</option>
                                <option value="false">Not Available</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ingredients (comma separated)</label>
                        <input type="text" class="form-control" name="ingredients" placeholder="e.g., Rice, Chicken, Spices">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tags (comma separated)</label>
                        <input type="text" class="form-control" name="tags" placeholder="e.g., Spicy, Recommended, Bestseller">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Item Image</label>
                        <input type="file" class="form-control" name="image" accept="image/*">
                        <small class="text-muted">Max size: 2MB. Supported formats: JPG, PNG, JPEG</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveItemBtn">Save Item</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRestaurantId = '<%= selectedRestaurant?.id || "" %>';
    let currentMenuId = null;
    let selectedItems = new Set();
    
    document.addEventListener('DOMContentLoaded', function() {
        if (currentRestaurantId) {
            loadMenus(currentRestaurantId);
        }
        
        // Search functionality
        document.getElementById('searchItems').addEventListener('input', function(e) {
            filterItems(e.target.value);
        });
        
        // Select all items
        document.getElementById('selectAllItems').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            
            if (e.target.checked) {
                checkboxes.forEach(cb => selectedItems.add(cb.dataset.itemId));
            } else {
                selectedItems.clear();
            }
            toggleBulkActions();
        });
    });
    
    function loadMenus(restaurantId) {
        currentRestaurantId = restaurantId;
        fetch(`/api/manager/restaurants/${restaurantId}/menus`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderMenuList(data.menus);
                    if (data.menus.length > 0) {
                        loadMenuItems(data.menus[0].id);
                    }
                }
            });
    }
    
    function renderMenuList(menus) {
        const menuList = document.getElementById('menuList');
        menuList.innerHTML = '';
        
        menus.forEach(menu => {
            const menuItem = document.createElement('a');
            menuItem.href = '#';
            menuItem.className = 'list-group-item list-group-item-action';
            menuItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${menu.name}</strong>
                        <small class="d-block text-muted">${menu.description || ''}</small>
                    </div>
                    <span class="badge ${menu.is_active ? 'bg-success' : 'bg-danger'}">
                        ${menu.is_active ? 'Active' : 'Inactive'}
                    </span>
                </div>
            `;
            menuItem.addEventListener('click', (e) => {
                e.preventDefault();
                loadMenuItems(menu.id);
                // Update active state
                document.querySelectorAll('#menuList .list-group-item').forEach(item => {
                    item.classList.remove('active');
                });
                menuItem.classList.add('active');
            });
            menuList.appendChild(menuItem);
        });
        
        // Activate first menu
        if (menuList.firstChild) {
            menuList.firstChild.classList.add('active');
        }
    }
    
    function loadMenuItems(menuId) {
        currentMenuId = menuId;
        fetch(`/api/manager/menus/${menuId}/items`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderItemsTable(data.items);
                    document.getElementById('currentMenuTitle').textContent = `Items (${data.items.length})`;
                }
            });
    }
    
    function renderItemsTable(items) {
        const tbody = document.getElementById('itemsList');
        tbody.innerHTML = '';
        selectedItems.clear();
        document.getElementById('selectAllItems').checked = false;
        document.getElementById('bulkActions').style.display = 'none';
        
        if (items.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-utensils fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No items in this menu</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="form-check-input item-checkbox" data-item-id="${item.id}">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="item-image me-2">
                            <img src="${item.image_url || '/images/default-food.jpg'}" alt="${item.name}" class="rounded" width="40" height="40">
                        </div>
                        <div>
                            <strong>${item.name}</strong>
                            <small class="d-block text-muted">${item.description || ''}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <strong>₹${item.price}</strong>
                    ${item.discounted_price ? `<br><del class="text-muted">₹${item.discounted_price}</del>` : ''}
                </td>
                <td>${item.category || '-'}</td>
                <td>
                    <span class="badge ${item.is_available ? 'bg-success' : 'bg-danger'}">
                        ${item.is_available ? 'Available' : 'Unavailable'}
                    </span>
                </td>
                <td>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" ${item.is_popular ? 'checked' : ''} 
                               onchange="togglePopular('${item.id}', this.checked)">
                    </div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editItem('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="toggleAvailability('${item.id}', ${item.is_available})">
                            <i class="fas fa-power-off"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteItem('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Add checkbox event listeners
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedItems.add(this.dataset.itemId);
                } else {
                    selectedItems.delete(this.dataset.itemId);
                    document.getElementById('selectAllItems').checked = false;
                }
                toggleBulkActions();
            });
        });
    }
    
    function toggleBulkActions() {
        const bulkActions = document.getElementById('bulkActions');
        bulkActions.style.display = selectedItems.size > 0 ? 'block' : 'none';
    }
    
    function filterItems(searchTerm) {
        const rows = document.querySelectorAll('#itemsList tr');
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
        });
    }
    
    function addNewMenu() {
        const modal = new bootstrap.Modal(document.getElementById('addMenuModal'));
        modal.show();
    }
    
    function saveMenu() {
        const form = document.getElementById('addMenuForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        data.restaurant_id = currentRestaurantId;
        data.is_active = data.is_active === 'true';
        
        fetch('/api/manager/menus', {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Menu added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addMenuModal')).hide();
                loadMenus(currentRestaurantId);
            }
        });
    }
    
    function addNewItem() {
        if (!currentMenuId) {
            showNotification('Please select a menu first', 'warning');
            return;
        }
        
        document.getElementById('itemModalTitle').textContent = 'Add New Item';
        document.getElementById('itemForm').reset();
        document.getElementById('saveItemBtn').onclick = () => saveItem();
        
        const modal = new bootstrap.Modal(document.getElementById('itemModal'));
        modal.show();
    }
    
    function editItem(itemId) {
        fetch(`/api/manager/items/${itemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const item = data.item;
                    const form = document.getElementById('itemForm');
                    
                    // Populate form
                    form.name.value = item.name;
                    form.description.value = item.description || '';
                    form.category.value = item.category || '';
                    form.price.value = item.price;
                    form.discounted_price.value = item.discounted_price || '';
                    form.preparation_time_minutes.value = item.preparation_time_minutes || 15;
                    form.calories.value = item.calories || '';
                    form.is_veg.value = item.is_veg;
                    form.is_available.value = item.is_available;
                    form.ingredients.value = Array.isArray(item.ingredients) ? item.ingredients.join(', ') : '';
                    form.tags.value = Array.isArray(item.tags) ? item.tags.join(', ') : '';
                    
                    document.getElementById('itemModalTitle').textContent = 'Edit Item';
                    document.getElementById('saveItemBtn').onclick = () => updateItem(itemId);
                    
                    const modal = new bootstrap.Modal(document.getElementById('itemModal'));
                    modal.show();
                }
            });
    }
    
    function saveItem() {
        const form = document.getElementById('itemForm');
        const formData = new FormData(form);
        formData.append('menu_id', currentMenuId);
        formData.append('restaurant_id', currentRestaurantId);
        
        // Convert comma-separated strings to arrays
        const ingredients = formData.get('ingredients');
        const tags = formData.get('tags');
        if (ingredients) formData.set('ingredients', ingredients.split(',').map(i => i.trim()));
        if (tags) formData.set('tags', tags.split(',').map(t => t.trim()));
        
        fetch('/api/manager/items', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Item added successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
                loadMenuItems(currentMenuId);
            }
        });
    }
    
    function updateItem(itemId) {
        const form = document.getElementById('itemForm');
        const formData = new FormData(form);
        
        // Convert comma-separated strings to arrays
        const ingredients = formData.get('ingredients');
        const tags = formData.get('tags');
        if (ingredients) formData.set('ingredients', ingredients.split(',').map(i => i.trim()));
        if (tags) formData.set('tags', tags.split(',').map(t => t.trim()));
        
        fetch(`/api/manager/items/${itemId}`, {
            method: 'PUT',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Item updated successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('itemModal')).hide();
                loadMenuItems(currentMenuId);
            }
        });
    }
    
    function toggleAvailability(itemId, currentStatus) {
        const newStatus = !currentStatus;
        fetch(`/api/manager/items/${itemId}/availability`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_available: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Item ${newStatus ? 'enabled' : 'disabled'} successfully!`, 'success');
                loadMenuItems(currentMenuId);
            }
        });
    }
    
    function togglePopular(itemId, isPopular) {
        fetch(`/api/manager/items/${itemId}/popular`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_popular: isPopular })
        });
    }
    
    function deleteItem(itemId) {
        if (confirm('Are you sure you want to delete this item?')) {
            fetch(`/api/manager/items/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Item deleted successfully!', 'success');
                    loadMenuItems(currentMenuId);
                }
            });
        }
    }
    
    function bulkUpdateStatus(status) {
        if (selectedItems.size === 0) return;
        
        fetch('/api/manager/items/bulk-update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                item_ids: Array.from(selectedItems),
                is_available: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Updated ${selectedItems.size} items`, 'success');
                selectedItems.clear();
                loadMenuItems(currentMenuId);
            }
        });
    }
    
    function deleteSelectedItems() {
        if (selectedItems.size === 0) return;
        
        if (confirm(`Are you sure you want to delete ${selectedItems.size} items?`)) {
            fetch('/api/manager/items/bulk-delete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ item_ids: Array.from(selectedItems) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Deleted ${selectedItems.size} items`, 'success');
                    selectedItems.clear();
                    loadMenuItems(currentMenuId);
                }
            });
        }
    }
</script>

<style>
    .list-group-item.active {
        background-color: #4a6fa5;
        border-color: #4a6fa5;
    }
    
    .item-image img {
        object-fit: cover;
    }
    
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
    }
    
    .search-box {
        width: 200px;
    }
</style>