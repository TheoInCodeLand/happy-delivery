<%- include('../layouts/main', { title: 'Analytics', currentPage: 'analytics' }) %>

<div class="analytics-page">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Analytics Dashboard</h2>
            <p class="text-muted">Track your restaurant performance and insights</p>
        </div>
        <div class="col-md-6">
            <div class="d-flex justify-content-end gap-2">
                <select class="form-select w-auto" id="restaurantSelect">
                    <% restaurants.forEach(restaurant => { %>
                    <option value="<%= restaurant.id %>"><%= restaurant.name %></option>
                    <% }) %>
                </select>
                <select class="form-select w-auto" id="periodSelect">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
                <input type="date" class="form-control w-auto" id="customDate">
                <button class="btn btn-primary" onclick="loadAnalytics()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card bg-primary text-white">
                <h5>Total Revenue</h5>
                <h2 id="totalRevenue">₹0</h2>
                <p id="revenueChange">+0% from last period</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-success text-white">
                <h5>Total Orders</h5>
                <h2 id="totalOrders">0</h2>
                <p id="ordersChange">+0% from last period</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-warning text-white">
                <h5>Average Order Value</h5>
                <h2 id="avgOrderValue">₹0</h2>
                <p id="aovChange">+0% from last period</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-info text-white">
                <h5>Customer Rating</h5>
                <h2 id="avgRating">0.0 <i class="fas fa-star"></i></h2>
                <p id="ratingChange">Based on 0 reviews</p>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Revenue Trends</h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Order Sources</h5>
                </div>
                <div class="card-body">
                    <canvas id="orderSourcesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Top Selling Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Orders</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="topItemsTable">
                                <!-- Top items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Peak Hours</h5>
                </div>
                <div class="card-body">
                    <canvas id="peakHoursChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Insights -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Customer Demographics</h5>
                </div>
                <div class="card-body">
                    <canvas id="demographicsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Recent Reviews</h5>
                </div>
                <div class="card-body">
                    <div id="recentReviews">
                        <!-- Reviews will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let revenueChart, orderSourcesChart, peakHoursChart, demographicsChart;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadAnalytics();
    });
    
    function loadAnalytics() {
        const restaurantId = document.getElementById('restaurantSelect').value;
        const period = document.getElementById('periodSelect').value;
        const customDate = document.getElementById('customDate').value;
        
        fetch(`/api/manager/analytics?restaurant=${restaurantId}&period=${period}&date=${customDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStats(data.stats);
                    updateCharts(data.charts);
                    updateTopItems(data.topItems);
                    updateRecentReviews(data.reviews);
                }
            });
    }
    
    function updateStats(stats) {
        document.getElementById('totalRevenue').textContent = `₹${stats.total_revenue || 0}`;
        document.getElementById('totalOrders').textContent = stats.total_orders || 0;
        document.getElementById('avgOrderValue').textContent = `₹${stats.avg_order_value || 0}`;
        document.getElementById('avgRating').textContent = `${stats.avg_rating || 0} ⭐`;
        
        document.getElementById('revenueChange').textContent = 
            `${stats.revenue_change >= 0 ? '+' : ''}${stats.revenue_change || 0}% from last period`;
        document.getElementById('revenueChange').className = 
            `text-${stats.revenue_change >= 0 ? 'success' : 'danger'}`;
        
        document.getElementById('ordersChange').textContent = 
            `${stats.orders_change >= 0 ? '+' : ''}${stats.orders_change || 0}% from last period`;
        document.getElementById('ordersChange').className = 
            `text-${stats.orders_change >= 0 ? 'success' : 'danger'}`;
        
        document.getElementById('ratingChange').textContent = 
            `Based on ${stats.total_reviews || 0} reviews`;
    }
    
    function updateCharts(charts) {
        // Revenue Chart
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        if (revenueChart) revenueChart.destroy();
        revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: charts.revenue.labels,
                datasets: [{
                    label: 'Revenue',
                    data: charts.revenue.data,
                    borderColor: '#4a6fa5',
                    backgroundColor: 'rgba(74, 111, 165, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
        
        // Order Sources Chart
        const sourcesCtx = document.getElementById('orderSourcesChart').getContext('2d');
        if (orderSourcesChart) orderSourcesChart.destroy();
        orderSourcesChart = new Chart(sourcesCtx, {
            type: 'doughnut',
            data: {
                labels: charts.sources.labels,
                datasets: [{
                    data: charts.sources.data,
                    backgroundColor: ['#4a6fa5', '#28a745', '#ffc107', '#dc3545', '#17a2b8']
                }]
            }
        });
        
        // Peak Hours Chart
        const peakCtx = document.getElementById('peakHoursChart').getContext('2d');
        if (peakHoursChart) peakHoursChart.destroy();
        peakHoursChart = new Chart(peakCtx, {
            type: 'bar',
            data: {
                labels: charts.peak_hours.labels,
                datasets: [{
                    label: 'Orders',
                    data: charts.peak_hours.data,
                    backgroundColor: '#4a6fa5'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        // Demographics Chart
        const demoCtx = document.getElementById('demographicsChart').getContext('2d');
        if (demographicsChart) demographicsChart.destroy();
        demographicsChart = new Chart(demoCtx, {
            type: 'pie',
            data: {
                labels: ['New Customers', 'Returning Customers', 'VIP Customers'],
                datasets: [{
                    data: [40, 50, 10],
                    backgroundColor: ['#4a6fa5', '#28a745', '#ffc107']
                }]
            }
        });
    }
    
    function updateTopItems(items) {
        const tbody = document.getElementById('topItemsTable');
        tbody.innerHTML = '';
        
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No data available</td></tr>';
            return;
        }
        
        items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${item.image_url || '/images/default-food.jpg'}" 
                             alt="${item.name}" width="30" height="30" class="rounded me-2">
                        <span>${item.name}</span>
                    </div>
                </td>
                <td>${item.orders}</td>
                <td>₹${item.revenue}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function updateRecentReviews(reviews) {
        const container = document.getElementById('recentReviews');
        
        if (reviews.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No reviews yet</p>';
            return;
        }
        
        container.innerHTML = reviews.map(review => `
            <div class="review-item mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${review.customer_name}</strong>
                        <div class="star-rating">
                            ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                        </div>
                    </div>
                    <small class="text-muted">${formatTimeAgo(review.created_at)}</small>
                </div>
                <p class="mb-1">${review.comment}</p>
                ${review.reply ? `
                    <div class="review-reply bg-light p-2 rounded">
                        <small><strong>Your Reply:</strong> ${review.reply}</small>
                    </div>
                ` : `
                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="replyToReview('${review.id}')">
                        <i class="fas fa-reply"></i> Reply
                    </button>
                `}
            </div>
        `).join('');
    }
    
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 60) return `${diffMins} minutes ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        return `${diffDays} days ago`;
    }
    
    function replyToReview(reviewId) {
        const reply = prompt('Enter your reply:');
        if (reply) {
            fetch(`/api/manager/reviews/${reviewId}/reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reply })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Reply sent successfully!', 'success');
                    loadAnalytics();
                }
            });
        }
    }
</script>

<style>
    .stat-card {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        color: white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .stat-card h5 {
        opacity: 0.9;
        margin-bottom: 10px;
    }
    
    .stat-card h2 {
        margin: 10px 0;
        font-size: 2rem;
    }
    
    .star-rating {
        color: #ffc107;
    }
    
    .review-item {
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
    }
    
    .review-reply {
        border-left: 3px solid #4a6fa5;
    }
</style>